<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Teng Kok Wai (Walter)">
<meta name="dcterms.date" content="2024-10-21">
<title>In-Class Exercise 8 – Walter Teng’s Coursework for SMU ISSS626: Geospatial Analytics and Applications</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-4MGB7PXBSL"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4MGB7PXBSL', { 'anonymize_ip': true});
</script><script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script><link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="In-Class Exercise 8 – Walter Teng’s Coursework for SMU ISSS626: Geospatial Analytics and Applications">
<meta property="og:description" content="In this exercise, we will go through a sample exercise for Take-Home Exercise 3B and In-Class Exercise 08, which supplement what we have learnt in Hands-On Exercise 8.">
<meta property="og:image" content="https://isss626-gaa.netlify.app/In-class_Ex/In-class_Ex08/og-img.png">
<meta property="og:site_name" content="Walter Teng's Coursework for SMU ISSS626: Geospatial Analytics and Applications">
<meta name="twitter:title" content="In-Class Exercise 8 – Walter Teng’s Coursework for SMU ISSS626: Geospatial Analytics and Applications">
<meta name="twitter:description" content="In this exercise, we will go through a sample exercise for Take-Home Exercise 3B and In-Class Exercise 08, which supplement what we have learnt in Hands-On Exercise 8.">
<meta name="twitter:image" content="https://isss626-gaa.netlify.app/In-class_Ex/In-class_Ex08/og-img.png">
<meta name="twitter:creator" content="@davzoku">
<meta name="twitter:site" content="@davzoku">
<meta name="twitter:card" content="summary_large_image">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ISSS626 Geospatial Analytics and Applications</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on-exercises" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Hands-on Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on-exercises">
<li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01/Hands-on_Ex01a.html">
 <span class="dropdown-text">1A: Geospatial Data Wrangling with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex01/Hands-on_Ex01b.html">
 <span class="dropdown-text">1B: Choropleth Mapping with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02/Hands-on_Ex02a.html">
 <span class="dropdown-text">2A: 1st Order Spatial Point Patterns Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex02/Hands-on_Ex02b.html">
 <span class="dropdown-text">2B: 2nd Order Spatial Point Patterns Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex03/Hands-on_Ex03a.html">
 <span class="dropdown-text">3A: Network Constrained Spatial Point Patterns Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex04/Hands-on_Ex04a.html">
 <span class="dropdown-text">4A: Spatial Weights and Applications</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05/Hands-on_Ex05a.html">
 <span class="dropdown-text">5A: Global Measures of Spatial Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex05/Hands-on_Ex05b.html">
 <span class="dropdown-text">5B: Local Measures of Spatial Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex06/Hands-on_Ex06a.html">
 <span class="dropdown-text">6A: Geographical Segmentation with Spatially Constrained Clustering Techniques</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex07/Hands-on_Ex07a.html">
 <span class="dropdown-text">7A: Calibrating Hedonic Pricing Model for Private Highrise Property with GWR Method</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex08/Hands-on_Ex08a.html">
 <span class="dropdown-text">8A: Geographically Weighted Predictive Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex10/Hands-on_Ex9a.html">
 <span class="dropdown-text">9A: Modelling Geographical Accessibility</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex09/Hands-on_Ex10a.html">
 <span class="dropdown-text">10A: Processing and Visualising Flow Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Hands-on_Ex/Hands-on_Ex09/Hands-on_Ex10b.html">
 <span class="dropdown-text">10B: Calibrating Spatial Interaction Models with R</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-in-class-exercises" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">In-class Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-in-class-exercises">
<li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex01/In-class_Ex01.html">
 <span class="dropdown-text">In-class Exercise 01</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex02/In-class_Ex02.html">
 <span class="dropdown-text">In-class Exercise 02</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex03/In-class_Ex03.html">
 <span class="dropdown-text">In-class Exercise 03</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex04/In-class_Ex04.html">
 <span class="dropdown-text">In-class Exercise 04</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex05/In-class_Ex05.html">
 <span class="dropdown-text">In-class Exercise 05</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex06/In-class_Ex06.html">
 <span class="dropdown-text">In-class Exercise 06</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex07/In-class_Ex07.html">
 <span class="dropdown-text">In-class Exercise 07</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex08/In-class_Ex08.html">
 <span class="dropdown-text">In-class Exercise 08</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex09/In-class_Ex09.html">
 <span class="dropdown-text">In-class Exercise 09</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../In-class_Ex/In-class_Ex10/In-class_Ex10.html">
 <span class="dropdown-text">In-class Exercise 10</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home-exercises" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Take-home Exercises</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home-exercises">
<li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex01/Take-home_Ex01.html">
 <span class="dropdown-text">Take-home Exercise 01</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex02/Take-home_Ex02.html">
 <span class="dropdown-text">Take-home Exercise 02</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../Take-home_Ex/Take-home_Ex03/Take-home_Ex03.html">
 <span class="dropdown-text">Take-home Exercise 03</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../Exploration/index.html"> 
<span class="menu-text">Exploration</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text"><i class="fa-solid fa-house fa-md" aria-label="house"></i></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.walterteng.com"> 
<span class="menu-text"><i class="fa-solid fa-user fa-md" aria-label="user"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/tengkokwai/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/davzoku/isss626-gaa"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#exercise-reference" id="toc-exercise-reference" class="nav-link active" data-scroll-target="#exercise-reference"><span class="header-section-number">1</span> Exercise Reference</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview"><span class="header-section-number">2</span> Overview</a></li>
  <li><a href="#import-the-r-packages" id="toc-import-the-r-packages" class="nav-link" data-scroll-target="#import-the-r-packages"><span class="header-section-number">3</span> Import the R Packages</a></li>
  <li><a href="#data-wrangling" id="toc-data-wrangling" class="nav-link" data-scroll-target="#data-wrangling"><span class="header-section-number">4</span> Data Wrangling</a></li>
  <li><a href="#import-the-r-packages-1" id="toc-import-the-r-packages-1" class="nav-link" data-scroll-target="#import-the-r-packages-1"><span class="header-section-number">5</span> Import the R Packages</a></li>
  <li><a href="#the-data" id="toc-the-data" class="nav-link" data-scroll-target="#the-data"><span class="header-section-number">6</span> The Data</a></li>
  <li><a href="#data-sampling" id="toc-data-sampling" class="nav-link" data-scroll-target="#data-sampling"><span class="header-section-number">7</span> Data Sampling</a></li>
  <li>
<a href="#checking-of-overlapping-point" id="toc-checking-of-overlapping-point" class="nav-link" data-scroll-target="#checking-of-overlapping-point"><span class="header-section-number">8</span> Checking of overlapping point</a>
  <ul class="collapse">
<li><a href="#spatial-jitter" id="toc-spatial-jitter" class="nav-link" data-scroll-target="#spatial-jitter"><span class="header-section-number">8.1</span> Spatial jitter</a></li>
  </ul>
</li>
  <li>
<a href="#train-test-split" id="toc-train-test-split" class="nav-link" data-scroll-target="#train-test-split"><span class="header-section-number">9</span> Train-Test Split</a>
  <ul class="collapse">
<li><a href="#multicolinearity-check" id="toc-multicolinearity-check" class="nav-link" data-scroll-target="#multicolinearity-check"><span class="header-section-number">9.1</span> Multicolinearity Check</a></li>
  </ul>
</li>
  <li>
<a href="#building-non-spatial-multiple-linear-regression" id="toc-building-non-spatial-multiple-linear-regression" class="nav-link" data-scroll-target="#building-non-spatial-multiple-linear-regression"><span class="header-section-number">10</span> Building Non-Spatial Multiple Linear Regression</a>
  <ul class="collapse">
<li><a href="#multicolinearity-check-with-vif" id="toc-multicolinearity-check-with-vif" class="nav-link" data-scroll-target="#multicolinearity-check-with-vif"><span class="header-section-number">10.1</span> Multicolinearity Check with VIF</a></li>
  </ul>
</li>
  <li>
<a href="#predictive-modelling-with-gwr" id="toc-predictive-modelling-with-gwr" class="nav-link" data-scroll-target="#predictive-modelling-with-gwr"><span class="header-section-number">11</span> Predictive Modelling with gwr</a>
  <ul class="collapse">
<li><a href="#computing-adaptive-bandwidth" id="toc-computing-adaptive-bandwidth" class="nav-link" data-scroll-target="#computing-adaptive-bandwidth"><span class="header-section-number">11.1</span> Computing Adaptive Bandwidth</a></li>
  <li><a href="#model-calibration" id="toc-model-calibration" class="nav-link" data-scroll-target="#model-calibration"><span class="header-section-number">11.2</span> Model Calibration</a></li>
  <li><a href="#predicting-with-test-data" id="toc-predicting-with-test-data" class="nav-link" data-scroll-target="#predicting-with-test-data"><span class="header-section-number">11.3</span> Predicting with test data</a></li>
  </ul>
</li>
  <li>
<a href="#predictive-modelling-rf-method" id="toc-predictive-modelling-rf-method" class="nav-link" data-scroll-target="#predictive-modelling-rf-method"><span class="header-section-number">12</span> Predictive Modelling: RF method</a>
  <ul class="collapse">
<li><a href="#preparing-coordinate-data" id="toc-preparing-coordinate-data" class="nav-link" data-scroll-target="#preparing-coordinate-data"><span class="header-section-number">12.1</span> Preparing Coordinate Data</a></li>
  <li><a href="#calibrating-random-forest-model" id="toc-calibrating-random-forest-model" class="nav-link" data-scroll-target="#calibrating-random-forest-model"><span class="header-section-number">12.2</span> Calibrating Random Forest Model</a></li>
  <li><a href="#calibrating-grf-model" id="toc-calibrating-grf-model" class="nav-link" data-scroll-target="#calibrating-grf-model"><span class="header-section-number">12.3</span> Calibrating GRF Model</a></li>
  <li><a href="#predict-with-test-data" id="toc-predict-with-test-data" class="nav-link" data-scroll-target="#predict-with-test-data"><span class="header-section-number">12.4</span> Predict with Test Data</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">In-Class Exercise 8</h1>
<p class="subtitle lead">In this exercise, we will go through a sample exercise for Take-Home Exercise 3B and In-Class Exercise 08, which supplement what we have learnt in Hands-On Exercise 8.</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Teng Kok Wai (Walter) </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 21, 2024</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">October 31, 2024</p>
    </div>
  </div>
    
  </div>
  


</header><section id="exercise-reference" class="level2" data-number="1"><h2 data-number="1" class="anchored" data-anchor-id="exercise-reference">
<span class="header-section-number">1</span> Exercise Reference</h2>
<ul>
<li><a href="https://isss626-ay2024-25aug.netlify.app/in-class_ex/in-class_ex08/in-class_ex08#/title-slide">ISSS626 Geospatial Analytics and Applications – In-class Exercise 8: Supplement to Hands-on Exercise 8</a></li>
</ul></section><section id="overview" class="level2" data-number="2"><h2 data-number="2" class="anchored" data-anchor-id="overview">
<span class="header-section-number">2</span> Overview</h2>
<p>In this exercise, we will go through a sample exercise for Take-Home Exercise 3B and In-Class Exercise 08, which supplement what we have learnt in Hands-On Exercise 8.</p>
</section><section id="import-the-r-packages" class="level2" data-number="3"><h2 data-number="3" class="anchored" data-anchor-id="import-the-r-packages">
<span class="header-section-number">3</span> Import the R Packages</h2>
<p>The following R packages will be used in this exercise:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 37%">
<col style="width: 38%">
</colgroup>
<thead><tr class="header">
<th><strong>Package</strong></th>
<th><strong>Purpose</strong></th>
<th><strong>Use Case in Exercise</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>tidyverse</strong></td>
<td>A collection of R packages for data manipulation and visualization.</td>
<td>Data wrangling, cleaning, and visualization tasks.</td>
</tr>
<tr class="even">
<td><strong>sf</strong></td>
<td>Provides tools for handling spatial data.</td>
<td>Importing and managing geospatial data.</td>
</tr>
<tr class="odd">
<td><strong>httr</strong></td>
<td>Simplifies working with URLs and HTTP requests.</td>
<td>Accessing APIs and retrieving data from web services.</td>
</tr>
<tr class="even">
<td><strong>jsonlite</strong></td>
<td>Handles JSON data in R.</td>
<td>Parsing and working with JSON responses from APIs.</td>
</tr>
<tr class="odd">
<td><strong>rvest</strong></td>
<td>Facilitates web scraping.</td>
<td>Extracting data from websites.</td>
</tr>
</tbody>
</table>
<p>To install and load these packages, use the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span>, <span class="va">sf</span>, <span class="va">httr</span>, <span class="va">jsonlite</span>, <span class="va">rvest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="data-wrangling" class="level2" data-number="4"><h2 data-number="4" class="anchored" data-anchor-id="data-wrangling">
<span class="header-section-number">4</span> Data Wrangling</h2>
<p>The HDB resale data can be downloaded from <a href="https://data.gov.sg/datasets?query=resale&amp;page=1&amp;resultId=d_8b84c4ee58e3cfc0ece0d773c8ca6abc">here</a>. The dataset contains resale flat prices based on registration date from Jan 2017 to Sep 2024.</p>
<p>The code below reads the raw CSV file containing the resale flat data and filters it to include only records from January 2023 to September 2024.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resale</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/raw_data/resale.csv"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">&gt;=</span> <span class="st">"2023-01"</span> <span class="op">&amp;</span> <span class="va">month</span> <span class="op">&lt;=</span> <span class="st">"2024-09"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code tidies the data by creating new columns: - <code>address</code>: Combines <code>block</code> and <code>street_name</code> to form a complete address. - <code>remaining_lease_yr</code>: Extracts the remaining lease years as an integer. - <code>remaining_lease_mth</code>: Extracts the remaining lease months as an integer.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resale_tidy</span> <span class="op">&lt;-</span> <span class="va">resale</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>address <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">block</span>,<span class="va">street_name</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>remaining_lease_yr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_sub</span><span class="op">(</span><span class="va">remaining_lease</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>remaining_lease_mth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span></span>
<span>    <span class="fu">str_sub</span><span class="op">(</span><span class="va">remaining_lease</span>, <span class="fl">9</span>, <span class="fl">11</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we filter the tidy dataset to include only records from September 2024.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">resale_selected</span> <span class="op">&lt;-</span> <span class="va">resale_tidy</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">month</span> <span class="op">==</span> <span class="st">"2024-09"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we generate a sorted list of unique addresses from the filtered dataset. This will be used to retrieve geographical coordinates.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">add_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">resale_selected</span><span class="op">$</span><span class="va">address</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the code below, the <code>get_coords</code> function retrieves latitude and longitude coordinates for each address in the list. It uses the OneMap API to query addresses and returns a dataframe with postal codes and geographical coordinates: - If a single result is found, the coordinates are retrieved and stored. - If multiple results are found, addresses with “NIL” as postal are dropped, and the top result is selected. - If no valid results are found, <code>NA</code> is stored.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">get_coords</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">add_list</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Create a data frame to store all retrieved coordinates</span></span>
<span>  <span class="va">postal_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">add_list</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">#print(i)</span></span>
<span></span>
<span>    <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">GET</span><span class="op">(</span><span class="st">'https://www.onemap.gov.sg/api/common/elastic/search?'</span>,</span>
<span>           query<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>searchVal<span class="op">=</span><span class="va">i</span>,</span>
<span>                     returnGeom<span class="op">=</span><span class="st">'Y'</span>,</span>
<span>                     getAddrDetails<span class="op">=</span><span class="st">'Y'</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">fromJSON</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">rawToChar</a></span><span class="op">(</span><span class="va">r</span><span class="op">$</span><span class="va">content</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">found</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">found</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">results</span></span>
<span></span>
<span>    <span class="co"># Create a new data frame for each address</span></span>
<span>    <span class="va">new_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># If single result, append</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">found</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">postal</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">POSTAL</span></span>
<span>      <span class="va">lat</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">LATITUDE</span></span>
<span>      <span class="va">lng</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">$</span><span class="va">LONGITUDE</span></span>
<span>      <span class="va">new_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>address<span class="op">=</span> <span class="va">i</span>,</span>
<span>                            postal <span class="op">=</span> <span class="va">postal</span>,</span>
<span>                            latitude <span class="op">=</span> <span class="va">lat</span>,</span>
<span>                            longitude <span class="op">=</span> <span class="va">lng</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># If multiple results, drop NIL and append top 1</span></span>
<span>    <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">found</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># Remove those with NIL as postal</span></span>
<span>      <span class="va">res_sub</span> <span class="op">&lt;-</span> <span class="va">res</span><span class="op">[</span><span class="va">res</span><span class="op">$</span><span class="va">POSTAL</span> <span class="op">!=</span> <span class="st">"NIL"</span>, <span class="op">]</span></span>
<span></span>
<span>      <span class="co"># Set as NA first if no Postal</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">res_sub</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">new_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>address<span class="op">=</span> <span class="va">i</span>,</span>
<span>                                postal <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                                latitude <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                                longitude <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw">else</span><span class="op">{</span></span>
<span>        <span class="va">top1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">res_sub</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="va">postal</span> <span class="op">&lt;-</span> <span class="va">top1</span><span class="op">$</span><span class="va">POSTAL</span></span>
<span>        <span class="va">lat</span> <span class="op">&lt;-</span> <span class="va">top1</span><span class="op">$</span><span class="va">LATITUDE</span></span>
<span>        <span class="va">lng</span> <span class="op">&lt;-</span> <span class="va">top1</span><span class="op">$</span><span class="va">LONGITUDE</span></span>
<span>        <span class="va">new_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>address<span class="op">=</span> <span class="va">i</span>,</span>
<span>                              postal <span class="op">=</span> <span class="va">postal</span>,</span>
<span>                              latitude <span class="op">=</span> <span class="va">lat</span>,</span>
<span>                              longitude <span class="op">=</span> <span class="va">lng</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">new_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>address<span class="op">=</span> <span class="va">i</span>,</span>
<span>                            postal <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                            latitude <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                            longitude <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Add the row</span></span>
<span>    <span class="va">postal_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">postal_coords</span>, <span class="va">new_row</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">postal_coords</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We apply the function to the list of addresses and the retrieved coordinates are saved as an RDS file for future use.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">get_coords</span><span class="op">(</span><span class="va">add_list</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">coords</span>, <span class="st">"data/rds/coords.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This concludes the sample exercise on how to handle the dataset for Take-Home Exercise 3B.</p>
<hr>
<p>We will proceed with In-Class Exercise 08 next.</p>
</section><section id="import-the-r-packages-1" class="level2" data-number="5"><h2 data-number="5" class="anchored" data-anchor-id="import-the-r-packages-1">
<span class="header-section-number">5</span> Import the R Packages</h2>
<p>The following R packages will be used in this exercise:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 40%">
<col style="width: 38%">
</colgroup>
<thead><tr class="header">
<th><strong>Package</strong></th>
<th><strong>Purpose</strong></th>
<th><strong>Use Case in Exercise</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>sf</strong></td>
<td>Handles spatial data for vector operations.</td>
<td>Importing and manipulating geospatial data.</td>
</tr>
<tr class="even">
<td><strong>spdep</strong></td>
<td>Provides spatial dependence analysis tools.</td>
<td>Conducting spatial autocorrelation and spatial weights analysis.</td>
</tr>
<tr class="odd">
<td><strong>GWmodel</strong></td>
<td>Implements Geographically Weighted Models.</td>
<td>Building and analyzing geographically weighted regression models.</td>
</tr>
<tr class="even">
<td><strong>SpatialML</strong></td>
<td>Supports machine learning models with spatial data.</td>
<td>Applying machine learning techniques to spatial datasets.</td>
</tr>
<tr class="odd">
<td><strong>kableExtra</strong></td>
<td>Enhances table creation for displaying results.</td>
<td>Creating well-formatted tables for presenting data summaries.</td>
</tr>
<tr class="even">
<td><strong>tmap</strong></td>
<td>Creates thematic maps for spatial data visualization.</td>
<td>Visualizing geospatial data and model results.</td>
</tr>
<tr class="odd">
<td><strong>rsample</strong></td>
<td>Facilitates data resampling techniques for statistical modeling.</td>
<td>Splitting data into training and testing sets.</td>
</tr>
<tr class="even">
<td><strong>Metrics</strong></td>
<td>Provides performance metrics for model evaluation.</td>
<td>Assessing accuracy, RMSE, and other evaluation metrics.</td>
</tr>
<tr class="odd">
<td><strong>tidyverse</strong></td>
<td>A suite of packages for data manipulation and visualization.</td>
<td>Data wrangling, cleaning, and visualization tasks.</td>
</tr>
<tr class="even">
<td><strong>olsrr</strong></td>
<td>Tools for OLS regression diagnostics and variable selection.</td>
<td>Diagnosing and improving multiple linear regression models.</td>
</tr>
</tbody>
</table>
<p>To install and load these packages, use the following code:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">sf</span>, <span class="va">spdep</span>, <span class="va">GWmodel</span>, <span class="va">SpatialML</span>, <span class="va">kableExtra</span>,</span>
<span>               <span class="va">tmap</span>, <span class="va">rsample</span>, <span class="va">Metrics</span>, <span class="va">tidyverse</span>, <span class="va">olsrr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="the-data" class="level2" data-number="6"><h2 data-number="6" class="anchored" data-anchor-id="the-data">
<span class="header-section-number">6</span> The Data</h2>
<p>The data file <code>mdata.rds</code> consists of the following information:</p>
<table class="caption-top table">
<thead><tr class="header">
<th><strong>Dataset Type</strong></th>
<th><strong>Description</strong></th>
<th><strong>Source &amp; Format</strong></th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Aspatial Dataset</strong></td>
<td>HDB Resale data: A list of HDB resale transacted prices in Singapore from Jan 2017 onwards.</td>
<td>Data.gov.sg, CSV format</td>
</tr>
<tr class="even">
<td><strong>Geospatial Dataset</strong></td>
<td>
<em>MP14_SUBZONE_WEB_PL</em>: URA 2014 Master Plan Planning Subzone boundary data.</td>
<td>Data.gov.sg, ESRI Shapefile format</td>
</tr>
<tr class="odd">
<td><strong>Locational Factors with Geographic Coordinates</strong></td>
<td>Eldercare data: A list of eldercare locations in Singapore.</td>
<td>Data.gov.sg, Shapefile format</td>
</tr>
<tr class="even">
<td></td>
<td>Hawker Centre data: A list of hawker centres in Singapore.</td>
<td>Data.gov.sg, GeoJSON format</td>
</tr>
<tr class="odd">
<td></td>
<td>Parks data: A list of parks in Singapore.</td>
<td>Data.gov.sg, GeoJSON format</td>
</tr>
<tr class="even">
<td></td>
<td>Supermarket data: A list of supermarkets in Singapore.</td>
<td>Data.gov.sg, GeoJSON format</td>
</tr>
<tr class="odd">
<td></td>
<td>CHAS Clinics data: A list of CHAS clinics in Singapore.</td>
<td>Data.gov.sg, GeoJSON format</td>
</tr>
<tr class="even">
<td></td>
<td>Childcare Service data: A list of childcare services in Singapore.</td>
<td>Data.gov.sg, GeoJSON format</td>
</tr>
<tr class="odd">
<td></td>
<td>Kindergartens data: A list of kindergartens in Singapore.</td>
<td>Data.gov.sg, GeoJSON format</td>
</tr>
<tr class="even">
<td></td>
<td>MRT data: A list of MRT/LRT stations with names and codes.</td>
<td>Datamall.lta.gov.sg, Shapefile format</td>
</tr>
<tr class="odd">
<td></td>
<td>Bus Stops data: A list of bus stops in Singapore.</td>
<td>Datamall.lta.gov.sg, Shapefile format</td>
</tr>
<tr class="even">
<td><strong>Locational Factors without Geographic Coordinates</strong></td>
<td>Primary School data: General information on schools in Singapore.</td>
<td>Data.gov.sg, CSV format</td>
</tr>
<tr class="odd">
<td></td>
<td>CBD Coordinates: Central Business District coordinates obtained from Google.</td>
<td>Google</td>
</tr>
<tr class="even">
<td></td>
<td>Shopping Malls data: A list of shopping malls in Singapore.</td>
<td>Wikipedia, <a href="https://en.wikipedia.org/wiki/List_of_shopping_malls_in_Singapore">List of shopping malls in Singapore</a>
</td>
</tr>
<tr class="odd">
<td></td>
<td>Good Primary Schools: A ranking of primary schools based on popularity.</td>
<td><a href="https://www.salary.sg/2021/best-primary-schools-2021-by-popularity">Local Salary Forum</a></td>
</tr>
</tbody>
</table>
<p>To load the dataset into R:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mdata</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/mdata.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="data-sampling" class="level2" data-number="7"><h2 data-number="7" class="anchored" data-anchor-id="data-sampling">
<span class="header-section-number">7</span> Data Sampling</h2>
<p>Calibrating predictive models are computational intensive, especially random forest method is used. For quick prototyping, a 10% sample will be selected at random from the data by using the code block below.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">HDB_sample</span> <span class="op">&lt;-</span> <span class="va">mdata</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">sample_n</span><span class="op">(</span><span class="fl">1500</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="checking-of-overlapping-point" class="level2" data-number="8"><h2 data-number="8" class="anchored" data-anchor-id="checking-of-overlapping-point">
<span class="header-section-number">8</span> Checking of overlapping point</h2>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>When using GWmodel to calibrate explanatory or predictive models, <strong>it is very important to ensure that there are no overlapping point features.</strong></p>
</div>
</div>
<p>The code block below is used to check if there are overlapping point features.</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">overlapping_points</span> <span class="op">&lt;-</span> <span class="va">HDB_sample</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>overlap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lengths.html">lengths</a></span><span class="op">(</span><span class="fu">st_equals</span><span class="op">(</span><span class="va">.</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="spatial-jitter" class="level3" data-number="8.1"><h3 data-number="8.1" class="anchored" data-anchor-id="spatial-jitter">
<span class="header-section-number">8.1</span> Spatial jitter</h3>
<p>In the code code block below, <a href="https://r-spatial.github.io/sf/reference/st_jitter.html"><code>st_jitter()</code></a> of <strong>sf</strong> package is used to move the point features by 5m to avoid overlapping point features.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">HDB_sample</span> <span class="op">&lt;-</span> <span class="va">HDB_sample</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_jitter</span><span class="op">(</span>amount <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="train-test-split" class="level2" data-number="9"><h2 data-number="9" class="anchored" data-anchor-id="train-test-split">
<span class="header-section-number">9</span> Train-Test Split</h2>
<p>Note that in this case, we use random sampling method to split the data into training and testing sets. No stratification was applied. (We should adopt a stratification method for Take-Home Exercise 3B to ensure better representation across subgroups.)</p>
<p>We will use <em>initial_split()</em> of <strong>rsample</strong> package. <code>rsample</code> is a package from <a href="https://www.tidymodels.org/">tidymodels framework</a>.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">resale_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">mdata</span>,</span>
<span>                              prop <span class="op">=</span> <span class="fl">6.5</span><span class="op">/</span><span class="fl">10</span>,<span class="op">)</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">resale_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">resale_split</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">write_rds</span><span class="op">(</span><span class="va">train_data</span>, <span class="st">"data/rds/train_data.rds"</span><span class="op">)</span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">test_data</span>, <span class="st">"data/rds/test_data.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/train_data.rds"</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/test_data.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="multicolinearity-check" class="level3" data-number="9.1"><h3 data-number="9.1" class="anchored" data-anchor-id="multicolinearity-check">
<span class="header-section-number">9.1</span> Multicolinearity Check</h3>
<p>Multicollinearity can affect the stability and interpretability of a regression model. To identify potential multicollinearity, we will use <a href="https://indrajeetpatil.github.io/ggstatsplot/articles/web_only/ggcorrmat.html"><code>ggcorrmat()</code></a> of <strong>ggstatsplot</strong> to plot a correlation matrix to check if there are pairs of highly correlated independent variables.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mdata_nogeo</span> <span class="op">&lt;-</span> <span class="va">mdata</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggstatsplot</span><span class="fu">::</span><span class="fu"><a href="https://indrajeetpatil.github.io/ggstatsplot/reference/ggcorrmat.html">ggcorrmat</a></span><span class="op">(</span><span class="va">mdata_nogeo</span><span class="op">[</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">17</span><span class="op">]</span><span class="op">)</span> <span class="co">#columns 2 to 17 to plot Correlation Matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="In-class_Ex08_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="building-non-spatial-multiple-linear-regression" class="level2" data-number="10"><h2 data-number="10" class="anchored" data-anchor-id="building-non-spatial-multiple-linear-regression">
<span class="header-section-number">10</span> Building Non-Spatial Multiple Linear Regression</h2>
<p>When constructing predictive models, it is advisable to avoid including all variables to avoid overfitting. Instead, only the most relevant predictors that contribute to the model’s performance should be selected.</p>
<p>On the other hand, explanatory models aim to understand relationships between variables and identify which factors have significant effects on the outcome. In such cases, including all variables can help provide a clearer picture of these relationships.</p>
<p>In this example, we build a non-spatial multiple linear regression model using the training data,</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Build model</span></span>
<span><span class="va">price_mlr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">resale_price</span> <span class="op">~</span> <span class="va">floor_area_sqm</span> <span class="op">+</span></span>
<span>                  <span class="va">storey_order</span> <span class="op">+</span> <span class="va">remaining_lease_mths</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_CBD</span> <span class="op">+</span> <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span> <span class="va">PROX_HAWKER</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>                  <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span></span>
<span>                  <span class="va">WITHIN_1KM_PRISCH</span>,</span>
<span>                data<span class="op">=</span><span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check model with olsrr</span></span>
<span><span class="fu">olsrr</span><span class="fu">::</span><span class="fu"><a href="https://olsrr.rsquaredacademy.com/reference/ols_regress.html">ols_regress</a></span><span class="op">(</span><span class="va">price_mlr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                              Model Summary                                
--------------------------------------------------------------------------
R                           0.859       RMSE                    61604.120 
R-Squared                   0.737       MSE                3800583670.022 
Adj. R-Squared              0.737       Coef. Var                  14.193 
Pred R-Squared              0.737       AIC                    257320.224 
MAE                     47485.556       SBC                    257436.117 
--------------------------------------------------------------------------
 RMSE: Root Mean Square Error 
 MSE: Mean Square Error 
 MAE: Mean Absolute Error 
 AIC: Akaike Information Criteria 
 SBC: Schwarz Bayesian Criteria 

                                     ANOVA                                       
--------------------------------------------------------------------------------
                    Sum of                                                      
                   Squares           DF       Mean Square       F          Sig. 
--------------------------------------------------------------------------------
Regression    1.100899e+14           14      7.863561e+12     2069.04    0.0000 
Residual      3.922202e+13        10320    3800583670.022                       
Total         1.493119e+14        10334                                         
--------------------------------------------------------------------------------

                                               Parameter Estimates                                                 
------------------------------------------------------------------------------------------------------------------
                   model          Beta    Std. Error    Std. Beta       t        Sig          lower         upper 
------------------------------------------------------------------------------------------------------------------
             (Intercept)    107601.073     10601.261                  10.150    0.000     86820.546    128381.599 
          floor_area_sqm      2780.698        90.579        0.164     30.699    0.000      2603.146      2958.251 
            storey_order     14299.298       339.115        0.234     42.167    0.000     13634.567     14964.029 
    remaining_lease_mths       344.490         4.592        0.442     75.027    0.000       335.489       353.490 
                PROX_CBD    -16930.196       201.254       -0.586    -84.124    0.000    -17324.693    -16535.700 
        PROX_ELDERLYCARE    -14441.025       994.867       -0.079    -14.516    0.000    -16391.157    -12490.893 
             PROX_HAWKER    -19265.648      1273.597       -0.083    -15.127    0.000    -21762.144    -16769.151 
                PROX_MRT    -32564.272      1744.232       -0.105    -18.670    0.000    -35983.305    -29145.240 
               PROX_PARK     -5712.625      1483.885       -0.021     -3.850    0.000     -8621.328     -2803.922 
               PROX_MALL    -14717.388      2007.818       -0.044     -7.330    0.000    -18653.100    -10781.675 
        PROX_SUPERMARKET    -26881.938      4189.624       -0.035     -6.416    0.000    -35094.414    -18669.462 
WITHIN_350M_KINDERGARTEN      8520.472       632.812        0.072     13.464    0.000      7280.038      9760.905 
   WITHIN_350M_CHILDCARE     -4510.650       354.015       -0.074    -12.741    0.000     -5204.589     -3816.711 
         WITHIN_350M_BUS       813.493       222.574        0.020      3.655    0.000       377.205      1249.781 
       WITHIN_1KM_PRISCH     -8010.834       491.512       -0.102    -16.298    0.000     -8974.293     -7047.376 
------------------------------------------------------------------------------------------------------------------</code></pre>
</div>
</div>
<section id="multicolinearity-check-with-vif" class="level3" data-number="10.1"><h3 data-number="10.1" class="anchored" data-anchor-id="multicolinearity-check-with-vif">
<span class="header-section-number">10.1</span> Multicolinearity Check with VIF</h3>
<p>Variance Inflation Factor (VIF) analysis is conducted to detect the presence of multicollinearity among the predictors. High VIF values suggest redundancy, indicating that some predictors might need to be removed.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">vif</span> <span class="op">&lt;-</span> <span class="fu">performance</span><span class="fu">::</span><span class="fu"><a href="https://easystats.github.io/performance/reference/check_collinearity.html">check_collinearity</a></span><span class="op">(</span><span class="va">price_mlr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">kable</span><span class="op">(</span><span class="va">vif</span>,</span>
<span>      caption <span class="op">=</span> <span class="st">"Variance Inflation Factor (VIF) Results"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">18</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Variance Inflation Factor (VIF) Results</caption>
<thead><tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">VIF</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">VIF_CI_low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">VIF_CI_high</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">SE_factor</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Tolerance</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Tolerance_CI_low</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Tolerance_CI_high</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">floor_area_sqm</td>
<td style="text-align: right;">1.126308</td>
<td style="text-align: right;">1.104360</td>
<td style="text-align: right;">1.152871</td>
<td style="text-align: right;">1.061276</td>
<td style="text-align: right;">0.8878567</td>
<td style="text-align: right;">0.8673997</td>
<td style="text-align: right;">0.9055016</td>
</tr>
<tr class="even">
<td style="text-align: left;">storey_order</td>
<td style="text-align: right;">1.206586</td>
<td style="text-align: right;">1.181102</td>
<td style="text-align: right;">1.235657</td>
<td style="text-align: right;">1.098447</td>
<td style="text-align: right;">0.8287846</td>
<td style="text-align: right;">0.8092862</td>
<td style="text-align: right;">0.8466672</td>
</tr>
<tr class="odd">
<td style="text-align: left;">remaining_lease_mths</td>
<td style="text-align: right;">1.363528</td>
<td style="text-align: right;">1.331762</td>
<td style="text-align: right;">1.398335</td>
<td style="text-align: right;">1.167702</td>
<td style="text-align: right;">0.7333919</td>
<td style="text-align: right;">0.7151363</td>
<td style="text-align: right;">0.7508850</td>
</tr>
<tr class="even">
<td style="text-align: left;">PROX_CBD</td>
<td style="text-align: right;">1.905054</td>
<td style="text-align: right;">1.852553</td>
<td style="text-align: right;">1.960788</td>
<td style="text-align: right;">1.380237</td>
<td style="text-align: right;">0.5249196</td>
<td style="text-align: right;">0.5099991</td>
<td style="text-align: right;">0.5397957</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PROX_ELDERLYCARE</td>
<td style="text-align: right;">1.178400</td>
<td style="text-align: right;">1.154108</td>
<td style="text-align: right;">1.206522</td>
<td style="text-align: right;">1.085541</td>
<td style="text-align: right;">0.8486080</td>
<td style="text-align: right;">0.8288284</td>
<td style="text-align: right;">0.8664703</td>
</tr>
<tr class="even">
<td style="text-align: left;">PROX_HAWKER</td>
<td style="text-align: right;">1.187828</td>
<td style="text-align: right;">1.163132</td>
<td style="text-align: right;">1.216262</td>
<td style="text-align: right;">1.089875</td>
<td style="text-align: right;">0.8418729</td>
<td style="text-align: right;">0.8221915</td>
<td style="text-align: right;">0.8597474</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PROX_MRT</td>
<td style="text-align: right;">1.240457</td>
<td style="text-align: right;">1.213579</td>
<td style="text-align: right;">1.270718</td>
<td style="text-align: right;">1.113758</td>
<td style="text-align: right;">0.8061545</td>
<td style="text-align: right;">0.7869568</td>
<td style="text-align: right;">0.8240092</td>
</tr>
<tr class="even">
<td style="text-align: left;">PROX_PARK</td>
<td style="text-align: right;">1.195883</td>
<td style="text-align: right;">1.170847</td>
<td style="text-align: right;">1.224588</td>
<td style="text-align: right;">1.093564</td>
<td style="text-align: right;">0.8362021</td>
<td style="text-align: right;">0.8166011</td>
<td style="text-align: right;">0.8540825</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PROX_MALL</td>
<td style="text-align: right;">1.409846</td>
<td style="text-align: right;">1.376277</td>
<td style="text-align: right;">1.446409</td>
<td style="text-align: right;">1.187369</td>
<td style="text-align: right;">0.7092975</td>
<td style="text-align: right;">0.6913675</td>
<td style="text-align: right;">0.7265978</td>
</tr>
<tr class="even">
<td style="text-align: left;">PROX_SUPERMARKET</td>
<td style="text-align: right;">1.154751</td>
<td style="text-align: right;">1.131493</td>
<td style="text-align: right;">1.182124</td>
<td style="text-align: right;">1.074594</td>
<td style="text-align: right;">0.8659873</td>
<td style="text-align: right;">0.8459353</td>
<td style="text-align: right;">0.8837880</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WITHIN_350M_KINDERGARTEN</td>
<td style="text-align: right;">1.125809</td>
<td style="text-align: right;">1.103886</td>
<td style="text-align: right;">1.152360</td>
<td style="text-align: right;">1.061042</td>
<td style="text-align: right;">0.8882499</td>
<td style="text-align: right;">0.8677846</td>
<td style="text-align: right;">0.9058910</td>
</tr>
<tr class="even">
<td style="text-align: left;">WITHIN_350M_CHILDCARE</td>
<td style="text-align: right;">1.335594</td>
<td style="text-align: right;">1.304923</td>
<td style="text-align: right;">1.369351</td>
<td style="text-align: right;">1.155679</td>
<td style="text-align: right;">0.7487304</td>
<td style="text-align: right;">0.7302729</td>
<td style="text-align: right;">0.7663289</td>
</tr>
<tr class="odd">
<td style="text-align: left;">WITHIN_350M_BUS</td>
<td style="text-align: right;">1.148544</td>
<td style="text-align: right;">1.125564</td>
<td style="text-align: right;">1.175729</td>
<td style="text-align: right;">1.071701</td>
<td style="text-align: right;">0.8706679</td>
<td style="text-align: right;">0.8505364</td>
<td style="text-align: right;">0.8884435</td>
</tr>
<tr class="even">
<td style="text-align: left;">WITHIN_1KM_PRISCH</td>
<td style="text-align: right;">1.550879</td>
<td style="text-align: right;">1.511876</td>
<td style="text-align: right;">1.592853</td>
<td style="text-align: right;">1.245343</td>
<td style="text-align: right;">0.6447958</td>
<td style="text-align: right;">0.6278044</td>
<td style="text-align: right;">0.6614298</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>To visualize the results:</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">vif</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="In-class_Ex08_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="predictive-modelling-with-gwr" class="level2" data-number="11"><h2 data-number="11" class="anchored" data-anchor-id="predictive-modelling-with-gwr">
<span class="header-section-number">11</span> Predictive Modelling with gwr</h2>
<section id="computing-adaptive-bandwidth" class="level3" data-number="11.1"><h3 data-number="11.1" class="anchored" data-anchor-id="computing-adaptive-bandwidth">
<span class="header-section-number">11.1</span> Computing Adaptive Bandwidth</h3>
<p>An adaptive bandwidth is calculated using geographically weighted regression (GWR), which allows for local variations in relationships between variables.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute adaptive bandwidth</span></span>
<span><span class="va">bw_adaptive</span> <span class="op">&lt;-</span> <span class="fu">bw.gwr</span><span class="op">(</span><span class="va">resale_price</span> <span class="op">~</span> <span class="va">floor_area_sqm</span> <span class="op">+</span></span>
<span>                  <span class="va">storey_order</span> <span class="op">+</span> <span class="va">remaining_lease_mths</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_CBD</span> <span class="op">+</span> <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span> <span class="va">PROX_HAWKER</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>                  <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span></span>
<span>                  <span class="va">WITHIN_1KM_PRISCH</span>,</span>
<span>                  data<span class="op">=</span><span class="va">train_data</span>,</span>
<span>                  approach<span class="op">=</span><span class="st">"CV"</span>,</span>
<span>                  kernel<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span>                  adaptive<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                  longlat<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we save this model for future use:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Save adaptive bandwidth</span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">bw_adaptive</span>, <span class="st">"data/rds/bw_adaptive.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bw_adaptive</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/bw_adaptive.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="model-calibration" class="level3" data-number="11.2"><h3 data-number="11.2" class="anchored" data-anchor-id="model-calibration">
<span class="header-section-number">11.2</span> Model Calibration</h3>
<p>The GWR model is then calibrated to examine spatially varying relationships:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calibrate gwr-based hedonic pricing model</span></span>
<span><span class="va">gwr_adaptive</span> <span class="op">&lt;-</span> <span class="fu">gwr.basic</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">resale_price</span> <span class="op">~</span></span>
<span>                            <span class="va">floor_area_sqm</span> <span class="op">+</span> <span class="va">storey_order</span> <span class="op">+</span></span>
<span>                            <span class="va">remaining_lease_mths</span> <span class="op">+</span> <span class="va">PROX_CBD</span> <span class="op">+</span></span>
<span>                            <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span> <span class="va">PROX_HAWKER</span> <span class="op">+</span></span>
<span>                            <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span></span>
<span>                            <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>                            <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span></span>
<span>                            <span class="va">WITHIN_1KM_PRISCH</span>,</span>
<span>                          data<span class="op">=</span><span class="va">train_data</span>,</span>
<span>                          bw <span class="op">=</span> <span class="va">bw_adaptive</span>,</span>
<span>                          kernel <span class="op">=</span> <span class="st">'gaussian'</span>,</span>
<span>                          adaptive<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                          longlat <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we save this calibrated model for future use:</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Save calibrated model</span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">gwr_adaptive</span>, <span class="st">"data/rds/gwr_adaptive.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gwr_adaptive</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/gwr_adaptive.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="predicting-with-test-data" class="level3" data-number="11.3"><h3 data-number="11.3" class="anchored" data-anchor-id="predicting-with-test-data">
<span class="header-section-number">11.3</span> Predicting with test data</h3>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute test data adaptive bandwidth</span></span>
<span><span class="va">gwr_bw_test_adaptive</span> <span class="op">&lt;-</span> <span class="fu">bw.gwr</span><span class="op">(</span><span class="va">resale_price</span> <span class="op">~</span> <span class="va">floor_area_sqm</span> <span class="op">+</span></span>
<span>                  <span class="va">storey_order</span> <span class="op">+</span> <span class="va">remaining_lease_mths</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_CBD</span> <span class="op">+</span> <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span> <span class="va">PROX_HAWKER</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span></span>
<span>                  <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>                  <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span></span>
<span>                  <span class="va">WITHIN_1KM_PRISCH</span>,</span>
<span>                  data<span class="op">=</span><span class="va">test_data</span>,</span>
<span>                  approach<span class="op">=</span><span class="st">"CV"</span>,</span>
<span>                  kernel<span class="op">=</span><span class="st">"gaussian"</span>,</span>
<span>                  adaptive<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                  longlat<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we save the output for future use:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">write_rds</span><span class="op">(</span><span class="va">gwr_bw_test_adaptive</span>,</span>
<span>          <span class="st">"data/rds/gwr_bw_test.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># #| eval: False</span></span>
<span><span class="va">gwr_bw_test_adaptive</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span></span>
<span>  <span class="st">"data/rds/gwr_bw_test.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To compute the predicted values:</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Compute predicted values</span></span>
<span><span class="va">gwr_pred</span> <span class="op">&lt;-</span> <span class="fu">gwr.predict</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">resale_price</span> <span class="op">~</span></span>
<span>                          <span class="va">floor_area_sqm</span> <span class="op">+</span> <span class="va">storey_order</span> <span class="op">+</span></span>
<span>                          <span class="va">remaining_lease_mths</span> <span class="op">+</span> <span class="va">PROX_CBD</span> <span class="op">+</span> </span>
<span>                          <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span> <span class="va">PROX_HAWKER</span> <span class="op">+</span> </span>
<span>                          <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span> </span>
<span>                          <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>                          <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span> </span>
<span>                          <span class="va">WITHIN_1KM_PRISCH</span>, </span>
<span>                        data<span class="op">=</span><span class="va">train_data</span>, </span>
<span>                        predictdata <span class="op">=</span> <span class="va">test_data</span>, </span>
<span>                        bw<span class="op">=</span><span class="va">bw_adaptive</span>, </span>
<span>                        kernel <span class="op">=</span> <span class="st">'gaussian'</span>, </span>
<span>                        adaptive<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>                        longlat <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="predictive-modelling-rf-method" class="level2" data-number="12"><h2 data-number="12" class="anchored" data-anchor-id="predictive-modelling-rf-method">
<span class="header-section-number">12</span> Predictive Modelling: RF method</h2>
<p>Since the <code>SpatialML</code> package is based on the <code>ranger</code> package, coordinate data must be prepared before calibration.</p>
<section id="preparing-coordinate-data" class="level3" data-number="12.1"><h3 data-number="12.1" class="anchored" data-anchor-id="preparing-coordinate-data">
<span class="header-section-number">12.1</span> Preparing Coordinate Data</h3>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get coordinates from full, training and test data</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">st_coordinates</span><span class="op">(</span><span class="va">mdata</span><span class="op">)</span></span>
<span><span class="va">coords_train</span> <span class="op">&lt;-</span> <span class="fu">st_coordinates</span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span>
<span><span class="va">coords_test</span> <span class="op">&lt;-</span> <span class="fu">st_coordinates</span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">coords_train</span>, <span class="st">"data/rds/coords_train.rds"</span> <span class="op">)</span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">coords_test</span>, <span class="st">"data/rds/coords_test.rds"</span> <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">coords_train</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/coords_train.rds"</span><span class="op">)</span></span>
<span><span class="va">coords_test</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/coords_test.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Additionally, the geometry field is removed:</p>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Drop geometry</span></span>
<span><span class="va">train_data_nogeom</span> <span class="op">&lt;-</span> <span class="va">train_data</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="calibrating-random-forest-model" class="level3" data-number="12.2"><h3 data-number="12.2" class="anchored" data-anchor-id="calibrating-random-forest-model">
<span class="header-section-number">12.2</span> Calibrating Random Forest Model</h3>
<p>To calibrate a RF model:</p>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Set seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate random forest model</span></span>
<span><span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu">ranger</span><span class="op">(</span><span class="va">resale_price</span> <span class="op">~</span> <span class="va">floor_area_sqm</span> <span class="op">+</span> <span class="va">storey_order</span> <span class="op">+</span></span>
<span>               <span class="va">remaining_lease_mths</span> <span class="op">+</span> <span class="va">PROX_CBD</span> <span class="op">+</span> <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span></span>
<span>               <span class="va">PROX_HAWKER</span> <span class="op">+</span> <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span></span>
<span>               <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>               <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span></span>
<span>               <span class="va">WITHIN_1KM_PRISCH</span>,</span>
<span>             data<span class="op">=</span><span class="va">train_data_nogeom</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check result</span></span>
<span><span class="va">rf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(resale_price ~ floor_area_sqm + storey_order + remaining_lease_mths +      PROX_CBD + PROX_ELDERLYCARE + PROX_HAWKER + PROX_MRT + PROX_PARK +      PROX_MALL + PROX_SUPERMARKET + WITHIN_350M_KINDERGARTEN +      WITHIN_350M_CHILDCARE + WITHIN_350M_BUS + WITHIN_1KM_PRISCH,      data = train_data_nogeom) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      10335 
Number of independent variables:  14 
Mtry:                             3 
Target node size:                 5 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       731404460 
R squared (OOB):                  0.9493789 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">write_rds</span><span class="op">(</span><span class="va">rf</span>, <span class="st">"data/rds/rf.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/rf.rds"</span><span class="op">)</span></span>
<span><span class="va">rf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(resale_price ~ floor_area_sqm + storey_order + remaining_lease_mths +      PROX_CBD + PROX_ELDERLYCARE + PROX_HAWKER + PROX_MRT + PROX_PARK +      PROX_MALL + PROX_SUPERMARKET + WITHIN_350M_KINDERGARTEN +      WITHIN_350M_CHILDCARE + WITHIN_350M_BUS + WITHIN_1KM_PRISCH,      data = train_data_nogeom) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      10335 
Number of independent variables:  14 
Mtry:                             3 
Target node size:                 5 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       731404460 
R squared (OOB):                  0.9493789 </code></pre>
</div>
</div>
</section><section id="calibrating-grf-model" class="level3" data-number="12.3"><h3 data-number="12.3" class="anchored" data-anchor-id="calibrating-grf-model">
<span class="header-section-number">12.3</span> Calibrating GRF Model</h3>
<p>To calibrate a GRF model:</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># #| eval: False</span></span>
<span><span class="co"># Set seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate geographic random forest model</span></span>
<span><span class="va">gwRF_adaptive</span> <span class="op">&lt;-</span> <span class="fu">grf</span><span class="op">(</span>formula <span class="op">=</span> <span class="va">resale_price</span> <span class="op">~</span> <span class="va">floor_area_sqm</span> <span class="op">+</span> <span class="va">storey_order</span> <span class="op">+</span></span>
<span>                       <span class="va">remaining_lease_mths</span> <span class="op">+</span> <span class="va">PROX_CBD</span> <span class="op">+</span> <span class="va">PROX_ELDERLYCARE</span> <span class="op">+</span></span>
<span>                       <span class="va">PROX_HAWKER</span> <span class="op">+</span> <span class="va">PROX_MRT</span> <span class="op">+</span> <span class="va">PROX_PARK</span> <span class="op">+</span> <span class="va">PROX_MALL</span> <span class="op">+</span></span>
<span>                       <span class="va">PROX_SUPERMARKET</span> <span class="op">+</span> <span class="va">WITHIN_350M_KINDERGARTEN</span> <span class="op">+</span></span>
<span>                       <span class="va">WITHIN_350M_CHILDCARE</span> <span class="op">+</span> <span class="va">WITHIN_350M_BUS</span> <span class="op">+</span></span>
<span>                       <span class="va">WITHIN_1KM_PRISCH</span>,</span>
<span>                     dframe<span class="op">=</span><span class="va">train_data_nogeom</span>,</span>
<span>                     bw<span class="op">=</span><span class="fl">55</span>,</span>
<span>                     ntree <span class="op">=</span> <span class="fl">100</span>, <span class="co"># default - 500</span></span>
<span>                     mtry <span class="op">=</span> <span class="fl">2</span>, <span class="co"># default - p/3 ~ 4</span></span>
<span>                     kernel<span class="op">=</span><span class="st">"adaptive"</span>,</span>
<span>                     coords<span class="op">=</span><span class="va">coords_train</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(resale_price ~ floor_area_sqm + storey_order + remaining_lease_mths +      PROX_CBD + PROX_ELDERLYCARE + PROX_HAWKER + PROX_MRT + PROX_PARK +      PROX_MALL + PROX_SUPERMARKET + WITHIN_350M_KINDERGARTEN +      WITHIN_350M_CHILDCARE + WITHIN_350M_BUS + WITHIN_1KM_PRISCH,      data = train_data_nogeom, num.trees = 100, mtry = 2, importance = "impurity",      num.threads = NULL) 

Type:                             Regression 
Number of trees:                  100 
Sample size:                      10335 
Number of independent variables:  14 
Mtry:                             2 
Target node size:                 5 
Variable importance mode:         impurity 
Splitrule:                        variance 
OOB prediction error (MSE):       852910439 
R squared (OOB):                  0.9409694 
          floor_area_sqm             storey_order     remaining_lease_mths 
            6.824704e+12             1.435742e+13             2.552037e+13 
                PROX_CBD         PROX_ELDERLYCARE              PROX_HAWKER 
            3.953814e+13             9.342137e+12             7.823712e+12 
                PROX_MRT                PROX_PARK                PROX_MALL 
            8.977883e+12             6.837247e+12             5.648711e+12 
        PROX_SUPERMARKET WITHIN_350M_KINDERGARTEN    WITHIN_350M_CHILDCARE 
            4.978032e+12             1.995655e+12             2.710805e+12 
         WITHIN_350M_BUS        WITHIN_1KM_PRISCH 
            2.674085e+12             9.334929e+12 
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-280245.37  -13938.89       9.62     193.26   15164.22  298800.00 
      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. 
-101882.33   -5505.77     144.69      32.36    6077.11  124333.78 
                               Min          Max        Mean         StD
floor_area_sqm                   0 342935222211 15130214965 30947225673
storey_order             215636836 183127037962 13238718931 20201703205
remaining_lease_mths     499341160 450850229473 23468200057 45872487449
PROX_CBD                  18349045 387976898577 12714159519 26521447462
PROX_ELDERLYCARE          15318889 300156818677 11449655559 23214713430
PROX_HAWKER               23102080 357846940402 11462149546 22914119254
PROX_MRT                  15735167 280468410292 11127206558 21802562779
PROX_PARK                  8185645 313013903378 10585959103 19977013805
PROX_MALL                 23261562 342701497449 11923313029 24424229742
PROX_SUPERMARKET           5486603 324945655359 11342139747 24323697099
WITHIN_350M_KINDERGARTEN         0 191962017128  3648095052 12301497250
WITHIN_350M_CHILDCARE            0 208967876431  6613838351 18044173338
WITHIN_350M_BUS                  0 168569774257  6196822101 12774759201
WITHIN_1KM_PRISCH                0 166710098545  2738509148  8263517948</code></pre>
</div>
</div>
<p>The model can be saved and loaded for future use:</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># #| eval: False</span></span>
<span><span class="co"># Save model output</span></span>
<span><span class="fu">write_rds</span><span class="op">(</span><span class="va">gwRF_adaptive</span>, <span class="st">"data/rds/gwRF_adaptive.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load model output</span></span>
<span><span class="va">gwRF_adaptive</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/gwRF_adaptive.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The global model is a <code>ranger</code> object which can provide additional insights:</p>
<ul>
<li>
<strong>Local Variable Importance</strong>: This metric calculates the importance of each variable for every data point, allowing us to see which predictors are more influential in different locations.</li>
<li>
<strong>Local Goodness of Fit (LGofFit)</strong>: For each data point, the model assesses how well the local predictions match the observed values, offering insights into model performance across different areas.</li>
<li>
<strong>Forests</strong>: Each local forest contains various metrics, such as sample size, to understand the local behavior and conditions affecting predictions.</li>
</ul>
</div>
</div>
</section><section id="predict-with-test-data" class="level3" data-number="12.4"><h3 data-number="12.4" class="anchored" data-anchor-id="predict-with-test-data">
<span class="header-section-number">12.4</span> Predict with Test Data</h3>
<p>Since the GRF model requires coordinate data as part of its input, the coordinates from the test data need to be merged with the original dataset after removing the geometry field.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_data_nogeom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span></span>
<span>  <span class="va">test_data</span>, <span class="va">coords_test</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_drop_geometry</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, <code>predict.grf()</code> of spatialML package will be used to predict the resale value by using the test data and gwRF_adaptive model calibrated earlier.</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">gwRF_pred</span> <span class="op">&lt;-</span> <span class="fu">predict.grf</span><span class="op">(</span><span class="va">gwRF_adaptive</span>,</span>
<span>                         <span class="va">test_data_nogeom</span>,</span>
<span>                         x.var.name<span class="op">=</span><span class="st">"X"</span>,</span>
<span>                         y.var.name<span class="op">=</span><span class="st">"Y"</span>,</span>
<span>                         local.w<span class="op">=</span><span class="fl">1</span>,</span>
<span>                         global.w<span class="op">=</span><span class="fl">0</span>,</span>
<span>                         nthreads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GRF_pred</span> <span class="op">&lt;-</span> <span class="fu">write_rds</span><span class="op">(</span><span class="va">gwRF_pred</span>, <span class="st">"data/rds/GRF_pred.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GRF_pred</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/GRF_pred.rds"</span><span class="op">)</span></span>
<span><span class="co"># create df</span></span>
<span><span class="va">GRF_pred_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">GRF_pred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To analyze the differences between the predicted and actual values, the predictions are merged back with the test dataset to compare predicted against actual resale prices.</p>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Combine predicted values with test data</span></span>
<span><span class="va">test_data_pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">test_data</span>, <span class="va">GRF_pred_df</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save the combined data for future reference:</p>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">write_rds</span><span class="op">(</span><span class="va">test_data_pred</span>, <span class="st">"data/rds/test_data_pred.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_data_pred</span> <span class="op">&lt;-</span> <span class="fu">read_rds</span><span class="op">(</span><span class="st">"data/rds/test_data_pred.rds"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To calculate Root Mean Square Error (RMSE):</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">rmse</span><span class="op">(</span><span class="va">test_data_pred</span><span class="op">$</span><span class="va">resale_price</span>,</span>
<span>     <span class="va">test_data_pred</span><span class="op">$</span><span class="va">GRF_pred</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 28961.7</code></pre>
</div>
</div>
<p>To visualize the predicted vs actual value with a scatterplot.</p>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">test_data_pred</span>,</span>
<span>       <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">GRF_pred</span>,</span>
<span>           y <span class="op">=</span> <span class="va">resale_price</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="In-class_Ex08_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Ideally, points should align along the diagonal line, indicating accurate predictions. Points below it show underestimation, while points above indicate overestimation of price prediction.</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/isss626-gaa\.netlify\.app\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>